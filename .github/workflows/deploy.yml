name: üöÄ Deploy to Yandex Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ —Å–±–æ—Ä–∫–∞
  build:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì• Install dependencies
      run: npm ci

    - name: üé® Build CSS with Tailwind
      run: npx tailwindcss -i ./src/styles.css -o ./dist/styles.css --minify

    - name: üì¶ Prepare static files
      run: |
        mkdir -p dist
        cp *.html dist/
        cp *.jpg *.png *.svg dist/ 2>/dev/null || true
        cp *.js dist/
        cp openapi.json dist/ 2>/dev/null || true

    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: static-files
        path: dist/
        retention-days: 1



  # –î–µ–ø–ª–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
  deploy-static:
    name: üì¶ Deploy Static Files
    runs-on: ubuntu-latest
    needs: [build, terraform]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: static-files
        path: dist/

    - name: üîß Setup Yandex Cloud CLI
      run: |
        # Install Yandex Cloud CLI
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        
        # Configure YC CLI
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set service-account-key /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        $HOME/yandex-cloud/bin/yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

    - name: üì§ Upload to Object Storage
      run: |
        # –°–æ–∑–¥–∞–µ–º –∏ –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ yc CLI
        for file in dist/*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "üìÅ –ó–∞–≥—Ä—É–∂–∞–µ–º: $filename"
            $HOME/yandex-cloud/bin/yc storage s3api put-object \
              --bucket ${{ secrets.YC_STORAGE_BUCKET }} \
              --key "$filename" \
              --body "$file" \
              --cache-control "max-age=86400"
          fi
        done
        echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã!"

    - name: üßπ Cleanup artifacts
      run: |
        rm -rf dist/
        rm -f /tmp/sa-key.json

  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Terraform (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  terraform:
    name: üèóÔ∏è Terraform Plan/Apply
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    defaults:
      run:
        working-directory: yandex-cloud/terraform
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: üì¶ Install dependencies
      run: |
        # Install jq for JSON parsing
        sudo apt-get update
        sudo apt-get install -y jq
        
        # Install Yandex Cloud CLI
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        
    - name: üîß Configure Yandex Cloud CLI
      run: |
        # Create service account key file
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/sa-key.json
        
        # Configure yc CLI
        $HOME/yandex-cloud/bin/yc config set service-account-key /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        $HOME/yandex-cloud/bin/yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        
        # Test configuration
        echo "‚úÖ YC CLI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
        $HOME/yandex-cloud/bin/yc config list

    - name: üì¶ Create function archives
      run: |
        cd ../functions/create-payment
        zip -r ../create-payment.zip .
        cd ../send-to-n8n
        zip -r ../send-to-n8n.zip .
        cd ../../terraform
        mkdir -p functions
        mv ../functions/create-payment.zip functions/
        mv ../functions/send-to-n8n.zip functions/

    - name: üîÑ Terraform Init
      run: terraform init

    - name: üìù Create Terraform variables file
      run: |
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."
        cat > terraform.tfvars << EOF
        folder_id = "${{ secrets.YC_FOLDER_ID }}"
        domain_name = "academycredit.ru"
        EOF
        echo "‚úÖ –§–∞–π–ª terraform.tfvars —Å–æ–∑–¥–∞–Ω"

    - name: üîç Verify YC CLI Configuration
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ YC CLI..."
        $HOME/yandex-cloud/bin/yc config list
        echo "‚úÖ YC CLI –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"

    - name: üìù Update import blocks with actual function IDs
      run: |
        echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ import –±–ª–æ–∫–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ ID —Ñ—É–Ω–∫—Ü–∏–π..."
        
        # –ü–æ–ª—É—á–∞–µ–º ID —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
        CREATE_PAYMENT_ID=$($HOME/yandex-cloud/bin/yc serverless function get create-payment --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        SEND_TO_N8N_ID=$($HOME/yandex-cloud/bin/yc serverless function get send-to-n8n --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        API_GATEWAY_ID=$($HOME/yandex-cloud/bin/yc serverless api-gateway get siteki-api --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        
        echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ ID:"
        echo "  create-payment: $CREATE_PAYMENT_ID"
        echo "  send-to-n8n: $SEND_TO_N8N_ID"
        echo "  api-gateway: $API_GATEWAY_ID"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º main.tf —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ ID –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
        if [[ -n "$CREATE_PAYMENT_ID" && "$CREATE_PAYMENT_ID" != "null" && "$CREATE_PAYMENT_ID" != "" ]]; then
          echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID –¥–ª—è create-payment —Ñ—É–Ω–∫—Ü–∏–∏..."
          sed -i "s/id = \"d4e7qmhtr3ms2kv5v6jg\"/id = \"$CREATE_PAYMENT_ID\"/" main.tf
        else
          echo "‚ö†Ô∏è create-payment —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É–¥–∞–ª—è–µ–º import –±–ª–æ–∫"
          sed -i '/# –ò–º–ø–æ—Ä—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ create-payment/,/^}$/d' main.tf
        fi
        
        if [[ -n "$SEND_TO_N8N_ID" && "$SEND_TO_N8N_ID" != "null" && "$SEND_TO_N8N_ID" != "" ]]; then
          echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID –¥–ª—è send-to-n8n —Ñ—É–Ω–∫—Ü–∏–∏..."
          sed -i "s/id = \"d4emo3l7d88cej49f3d9\"/id = \"$SEND_TO_N8N_ID\"/" main.tf
        else
          echo "‚ö†Ô∏è send-to-n8n —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É–¥–∞–ª—è–µ–º import –±–ª–æ–∫"
          sed -i '/# –ò–º–ø–æ—Ä—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ send-to-n8n/,/^}$/d' main.tf
        fi
        
        # API Gateway –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –≤ Yandex Cloud –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ
        if [[ -n "$API_GATEWAY_ID" && "$API_GATEWAY_ID" != "null" && "$API_GATEWAY_ID" != "" ]]; then
          echo "‚ö†Ô∏è API Gateway —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (ID: $API_GATEWAY_ID)"
          echo "üìù Yandex API Gateway –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç, —É–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π..."
          
          # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API Gateway –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
          if $HOME/yandex-cloud/bin/yc serverless api-gateway delete "$API_GATEWAY_ID" --async 2>/dev/null; then
            echo "‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π API Gateway —É–¥–∞–ª—ë–Ω"
            # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
            sleep 5
          else
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å API Gateway, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
          fi
        fi
        
        echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ import –±–ª–æ–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

    - name: üìã Terraform Plan
      run: |
        export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/sa-key.json"
        export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
        export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
        terraform plan -var-file=terraform.tfvars

    - name: üöÄ Terraform Apply
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/sa-key.json"
        export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
        export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
        terraform apply -auto-approve -var-file=terraform.tfvars

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ
  notify:
    name: üì¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [terraform, deploy-static]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ‚úÖ Success notification
      if: needs.terraform.result == 'success' && needs.deploy-static.result == 'success'
      run: |
        echo "üéâ Deployment successful!"
        echo "‚úÖ Functions deployed via Terraform"
        echo "‚úÖ Static files uploaded"
        echo "üåê Site is live at: https://${{ secrets.YC_STORAGE_BUCKET }}"

    - name: ‚ùå Failure notification
      if: needs.terraform.result == 'failure' || needs.deploy-static.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check the logs above for details."
        exit 1 