name: ðŸš€ Deploy to Yandex Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ°
  build:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¥ Install dependencies
      run: npm ci

    - name: ðŸŽ¨ Build CSS with Tailwind
      run: npx tailwindcss -i ./src/styles.css -o ./dist/styles.css --minify

    - name: ðŸ“¦ Prepare static files
      run: |
        mkdir -p dist
        cp *.html dist/
        cp *.jpg *.png *.svg dist/ 2>/dev/null || true
        cp *.js dist/
        cp openapi.json dist/ 2>/dev/null || true

    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: static-files
        path: dist/
        retention-days: 1



  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
  deploy-static:
    name: ðŸ“¦ Deploy Static Files
    runs-on: ubuntu-latest
    needs: [build, terraform]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: static-files
        path: dist/

    - name: ðŸ”§ Setup Yandex Cloud CLI
      run: |
        # Install Yandex Cloud CLI
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        
        # Configure YC CLI
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set service-account-key /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        $HOME/yandex-cloud/bin/yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

    - name: ðŸ“¤ Upload to Object Storage
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸ Ð²Ñ‹ÐºÐ»Ð°Ð´Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‡ÐµÑ€ÐµÐ· yc CLI
        for file in dist/*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "ðŸ“ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼: $filename"
            $HOME/yandex-cloud/bin/yc storage s3api put-object \
              --bucket ${{ secrets.YC_STORAGE_BUCKET }} \
              --key "$filename" \
              --body "$file" \
              --cache-control "max-age=86400"
          fi
        done
        echo "âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹!"

    - name: ðŸ§¹ Cleanup artifacts
      run: |
        rm -rf dist/
        rm -f /tmp/sa-key.json

  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Terraform (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
  terraform:
    name: ðŸ—ï¸ Terraform Plan/Apply
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    defaults:
      run:
        working-directory: yandex-cloud/terraform
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: ðŸ“¦ Install dependencies
      run: |
        # Install jq for JSON parsing
        sudo apt-get update
        sudo apt-get install -y jq
        
        # Install Yandex Cloud CLI
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        
    - name: ðŸ”§ Configure Yandex Cloud CLI
      run: |
        # Create service account key file
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/sa-key.json
        
        # Configure yc CLI
        $HOME/yandex-cloud/bin/yc config set service-account-key /tmp/sa-key.json
        $HOME/yandex-cloud/bin/yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        $HOME/yandex-cloud/bin/yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        
        # Test configuration
        echo "âœ… YC CLI ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ:"
        $HOME/yandex-cloud/bin/yc config list

    - name: ðŸ“¦ Create function archives
      run: |
        cd ../functions/create-payment
        zip -r ../create-payment.zip .
        cd ../send-to-n8n
        zip -r ../send-to-n8n.zip .
        cd ../../terraform
        mkdir -p functions
        mv ../functions/create-payment.zip functions/
        mv ../functions/send-to-n8n.zip functions/

    - name: ðŸ”„ Terraform Init
      run: terraform init

    - name: ðŸ“ Create Terraform variables file
      run: |
        echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…..."
        cat > terraform.tfvars << EOF
        folder_id = "${{ secrets.YC_FOLDER_ID }}"
        domain_name = "academycredit.ru"
        EOF
        echo "âœ… Ð¤Ð°Ð¹Ð» terraform.tfvars ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ” Verify YC CLI Configuration
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ YC CLI..."
        $HOME/yandex-cloud/bin/yc config list
        echo "âœ… YC CLI Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!"

    - name: ðŸ“ Update import blocks with actual function IDs
      run: |
        echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ import Ð±Ð»Ð¾ÐºÐ¾Ð² Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ ID Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ID ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
        CREATE_PAYMENT_ID=$($HOME/yandex-cloud/bin/yc serverless function get create-payment --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        SEND_TO_N8N_ID=$($HOME/yandex-cloud/bin/yc serverless function get send-to-n8n --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        API_GATEWAY_ID=$($HOME/yandex-cloud/bin/yc serverless api-gateway get siteki-api --format=json 2>/dev/null | jq -r '.id' 2>/dev/null || echo "")
        
        echo "ðŸ“‹ ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ ID:"
        echo "  create-payment: $CREATE_PAYMENT_ID"
        echo "  send-to-n8n: $SEND_TO_N8N_ID"
        echo "  api-gateway: $API_GATEWAY_ID"
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ main.tf Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ ID Ð´Ð»Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
        if [[ -n "$CREATE_PAYMENT_ID" && "$CREATE_PAYMENT_ID" != "null" && "$CREATE_PAYMENT_ID" != "" ]]; then
          echo "ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ID Ð´Ð»Ñ create-payment Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸..."
          sed -i "s/id = \"d4e7qmhtr3ms2kv5v6jg\"/id = \"$CREATE_PAYMENT_ID\"/" main.tf
        else
          echo "âš ï¸ create-payment Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ import Ð±Ð»Ð¾Ðº"
          sed -i '/# Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ create-payment/,/^}$/d' main.tf
        fi
        
        if [[ -n "$SEND_TO_N8N_ID" && "$SEND_TO_N8N_ID" != "null" && "$SEND_TO_N8N_ID" != "" ]]; then
          echo "ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ID Ð´Ð»Ñ send-to-n8n Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸..."
          sed -i "s/id = \"d4emo3l7d88cej49f3d9\"/id = \"$SEND_TO_N8N_ID\"/" main.tf
        else
          echo "âš ï¸ send-to-n8n Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ import Ð±Ð»Ð¾Ðº"
          sed -i '/# Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ send-to-n8n/,/^}$/d' main.tf
        fi
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ import Ð±Ð»Ð¾Ðº Ð´Ð»Ñ API Gateway ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if [[ -n "$API_GATEWAY_ID" && "$API_GATEWAY_ID" != "null" && "$API_GATEWAY_ID" != "" ]]; then
          echo "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ import Ð±Ð»Ð¾ÐºÐ° Ð´Ð»Ñ API Gateway..."
          cat >> main.tf << EOF
        
        # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ API Gateway
        import {
          to = yandex_api_gateway.siteki_gateway
          id = "$API_GATEWAY_ID"
        }
        EOF
        fi
        
        echo "âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ import Ð±Ð»Ð¾ÐºÐ¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"

    - name: ðŸ“‹ Terraform Plan
      run: |
        export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/sa-key.json"
        export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
        export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
        terraform plan -var-file=terraform.tfvars

    - name: ðŸš€ Terraform Apply
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        export YC_SERVICE_ACCOUNT_KEY_FILE="/tmp/sa-key.json"
        export YC_CLOUD_ID="${{ secrets.YC_CLOUD_ID }}"
        export YC_FOLDER_ID="${{ secrets.YC_FOLDER_ID }}"
        terraform apply -auto-approve -var-file=terraform.tfvars

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ
  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [terraform, deploy-static]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: âœ… Success notification
      if: needs.terraform.result == 'success' && needs.deploy-static.result == 'success'
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "âœ… Functions deployed via Terraform"
        echo "âœ… Static files uploaded"
        echo "ðŸŒ Site is live at: https://${{ secrets.YC_STORAGE_BUCKET }}"

    - name: âŒ Failure notification
      if: needs.terraform.result == 'failure' || needs.deploy-static.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details."
        exit 1 